<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Crypto Prices</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/chart.css') }}"
    />

    <nav>
      <ul>
        <li><a href="./">Home</a></li>
        <li><a href="./login">Se connecter</a></li>
        <li><a href="./register">S'inscrire</a></li>
      </ul>
    </nav>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="form-group">
            <label for="cryptoSelect">Selectionnez une crypto:</label>
            <select class="form-control" id="cryptoSelect">
              <option value="bitcoin">Bitcoin (BTC)</option>
              <option value="litecoin">Litecoin (LTC)</option>
              <option value="solana">Solana (SOL)</option>
            </select>
          </div>
          <div class="card">
            <div class="card-header">
              <h5 class="card-title">Prix des crypto</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="cryptoChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
      function getCryptoData(cryptoSymbol) {
        fetch(
          `https://api.coingecko.com/api/v3/coins/${cryptoSymbol}/market_chart?vs_currency=usd&days=1`
        )
          .then((response) => response.json())
          .then((data) => {
            var timestamps = data.prices.map((entry) => entry[0]);
            var prices = data.prices.map((entry) => entry[1]);

            var ctx = document.getElementById("cryptoChart").getContext("2d");

            // Détruire le graphique existant s'il y en a un
            if (window.cryptoChart instanceof Chart) {
              window.cryptoChart.destroy();
            }

            // Créer un nouveau graphique avec les nouvelles données
            window.cryptoChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: timestamps.map((timestamp) =>
                  moment(timestamp).format("MMM DD, YYYY HH:mm")
                ),
                datasets: [
                  {
                    label: `Prix du ${cryptoSymbol.toUpperCase()} (USD)`,
                    data: prices,
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                    pointRadius: 0,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  xAxes: [
                    {
                      type: "time",
                      distribution: "linear",
                      time: {
                        unit: "minute",
                      },
                      ticks: {
                        source: "auto",
                      },
                    },
                  ],
                  yAxes: [
                    {
                      ticks: {
                        beginAtZero: false,
                      },
                    },
                  ],
                },
              },
            });
          })
          .catch((error) => {
            console.error(`Error fetching ${cryptoSymbol} data:`, error);
          });
      }

      document
        .getElementById("cryptoSelect")
        .addEventListener("change", function () {
          var selectedCrypto = this.value;
          getCryptoData(selectedCrypto);
        });

      getCryptoData("bitcoin");
    </script>
  </body>
</html>
